<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CodeHero">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <title>Editor - {{ project.name }} - CodeHero</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <style>
        :root {
            --bg-primary: #07070d;
            --bg-secondary: #0d0d16;
            --bg-card: rgba(18, 18, 32, 0.7);
            --bg-card-hover: rgba(25, 25, 45, 0.8);
            --border-subtle: rgba(99, 102, 241, 0.15);
            --border-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-cyan: #22d3ee;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --glow-primary: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .aurora-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .aurora-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 20s ease-in-out infinite;
        }

        .aurora-blob:nth-child(1) {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.4) 0%, transparent 70%);
            top: -200px; left: -100px;
        }

        .aurora-blob:nth-child(2) {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%);
            top: 50%; right: -100px;
            animation-delay: -5s; animation-duration: 25s;
        }

        .aurora-blob:nth-child(3) {
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(34, 211, 238, 0.25) 0%, transparent 70%);
            bottom: -50px; left: 40%;
            animation-delay: -10s; animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.05); }
            50% { transform: translate(-30px, 50px) scale(0.95); }
            75% { transform: translate(-50px, -20px) scale(1.02); }
        }

        /* Header */
        .header {
            background: rgba(13, 13, 22, 0.9);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
            z-index: 10;
        }
        .header h1 {
            font-size: 1em;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header .project-name {
            -webkit-text-fill-color: var(--text-primary);
        }
        .nav { display: flex; gap: 15px; align-items: center; }
        .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .nav a:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        /* Toolbar */
        .toolbar {
            background: rgba(13, 13, 22, 0.8);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .toolbar button {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .toolbar button:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: var(--border-glow);
        }
        .toolbar button.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }
        .toolbar button.primary:hover {
            box-shadow: var(--glow-primary);
        }
        .toolbar button:disabled { opacity: 0.5; cursor: not-allowed; }
        .toolbar .separator { width: 1px; height: 20px; background: var(--border-subtle); margin: 0 5px; }
        .toolbar .file-path { color: var(--text-muted); font-size: 12px; font-family: 'JetBrains Mono', monospace; margin-left: auto; }
        .toolbar .modified { color: var(--accent-orange); }

        /* Main Container */
        .main { flex: 1; display: flex; overflow: hidden; }

        /* Sidebar - File Tree */
        .sidebar {
            width: 280px;
            background: rgba(13, 13, 22, 0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h3 {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .sidebar-header button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
        }
        .sidebar-header button:hover { color: var(--accent-cyan); }

        .tree-container { flex: 1; overflow-y: auto; padding: 10px 0; }
        .tree-container::-webkit-scrollbar { width: 6px; }
        .tree-container::-webkit-scrollbar-track { background: transparent; }
        .tree-container::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 3px; }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .tree-item:hover { background: rgba(99, 102, 241, 0.1); }
        .tree-item.active {
            background: rgba(99, 102, 241, 0.2);
            border-right: 2px solid var(--accent-primary);
        }
        .tree-item .icon { margin-right: 8px; font-size: 14px; flex-shrink: 0; }
        .tree-item .name { overflow: hidden; text-overflow: ellipsis; }
        .tree-item.dir .name { color: var(--accent-cyan); }
        .tree-item.file .name { color: var(--text-secondary); }

        .tree-children { display: none; }
        .tree-children.open { display: block; }
        .tree-children .tree-item { padding-left: 30px; }
        .tree-children .tree-children .tree-item { padding-left: 45px; }
        .tree-children .tree-children .tree-children .tree-item { padding-left: 60px; }
        .tree-children .tree-children .tree-children .tree-children .tree-item { padding-left: 75px; }

        /* Editor Container */
        .editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .editor-tabs {
            background: rgba(13, 13, 22, 0.8);
            display: flex;
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
            overflow-x: auto;
        }
        .editor-tabs::-webkit-scrollbar { height: 4px; }
        .editor-tabs::-webkit-scrollbar-thumb { background: var(--border-subtle); }

        .editor-tab {
            padding: 10px 15px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            border-right: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .editor-tab:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-secondary);
        }
        .editor-tab.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-primary);
        }
        .editor-tab .close { font-size: 14px; opacity: 0.5; }
        .editor-tab .close:hover { opacity: 1; color: var(--accent-red); }
        .editor-tab .modified-dot { width: 8px; height: 8px; background: var(--accent-orange); border-radius: 50%; }

        #editor { flex: 1; font-size: 14px; }

        .no-file {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 14px;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: rgba(18, 18, 32, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 6px 0;
            min-width: 160px;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            padding: 8px 15px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            transition: all 0.15s;
        }
        .context-menu-item:hover {
            background: rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
        }
        .context-menu-item.danger { color: var(--accent-red); }
        .context-menu-item.danger:hover { background: rgba(239, 68, 68, 0.2); }
        .context-menu-separator { height: 1px; background: var(--border-subtle); margin: 5px 0; }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: rgba(18, 18, 32, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            min-width: 320px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .modal-content h3 {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
        }
        .modal-content input {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s;
        }
        .modal-content input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .modal-buttons .cancel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        .modal-buttons .cancel:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }
        .modal-buttons .confirm {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        .modal-buttons .confirm:hover {
            box-shadow: var(--glow-primary);
        }
    </style>
</head>
<body>
    <div class="aurora-bg">
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
    </div>

    <div class="header">
        <h1>
            <span>Editor</span>
            <span style="opacity:0.3">/</span>
            <span class="project-name">{{ project.name }}</span>
        </h1>
        <div class="nav">
            <a href="/project/{{ project.id }}">‚Üê Back to Project</a>
            <a href="/dashboard">Dashboard</a>
        </div>
    </div>

    <div class="toolbar">
        <button onclick="saveCurrentFile()" id="btnSave" disabled class="primary">
            <span>üíæ</span> Save
        </button>
        <div class="separator"></div>
        <button onclick="showNewFileModal()">
            <span>üìÑ</span> New File
        </button>
        <button onclick="showNewFolderModal()">
            <span>üìÅ</span> New Folder
        </button>
        <div class="separator"></div>
        <button onclick="refreshTree()">
            <span>üîÑ</span> Refresh
        </button>
        <div class="file-path">
            <span id="currentPath">No file open</span>
            <span id="modifiedIndicator" class="modified" style="display:none"> (modified)</span>
        </div>
    </div>

    <div class="main">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Files</h3>
                <div style="display:flex;gap:4px;">
                    <button onclick="refreshTree()" title="Refresh">üîÑ</button>
                    <button onclick="popoutEditor()" title="Open Editor in new window">‚ßâ</button>
                </div>
            </div>
            <div class="tree-container" id="fileTree">
                <div style="padding:20px;color:#888;text-align:center">Loading...</div>
            </div>
        </div>

        <div class="editor-container">
            <div class="editor-tabs" id="editorTabs"></div>
            <div id="editor"></div>
            <div class="no-file" id="noFile">
                <div style="text-align:center">
                    <div style="font-size:48px;margin-bottom:15px">üìù</div>
                    <div>Select a file from the tree to edit</div>
                    <div style="margin-top:10px;font-size:12px;color:#444">Ctrl+S to save</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextNewFile()">üìÑ New File</div>
        <div class="context-menu-item" onclick="contextNewFolder()">üìÅ New Folder</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="contextRename()">‚úèÔ∏è Rename</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item danger" onclick="contextDelete()">üóëÔ∏è Delete</div>
    </div>

    <!-- New File/Folder Modal -->
    <div class="modal" id="newItemModal">
        <div class="modal-content">
            <h3 id="modalTitle">New File</h3>
            <input type="text" id="newItemName" placeholder="filename.ext" onkeydown="if(event.key==='Enter')confirmNewItem()">
            <div class="modal-buttons">
                <button class="cancel" onclick="hideModal()">Cancel</button>
                <button class="confirm" onclick="confirmNewItem()">Create</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <h3>Rename</h3>
            <input type="text" id="renameInput" placeholder="new name" onkeydown="if(event.key==='Enter')confirmRename()">
            <div class="modal-buttons">
                <button class="cancel" onclick="hideRenameModal()">Cancel</button>
                <button class="confirm" onclick="confirmRename()">Rename</button>
            </div>
        </div>
    </div>

    <script>
        const projectId = {{ project.id }};
        const basePath = '{{ project.web_path or project.app_path or "" }}';

        function popoutEditor() {
            const width = 1200;
            const height = 800;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            window.open(
                `/project/${projectId}/editor`,
                'CodeEditor_' + projectId,
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        }

        // Editor setup
        let editor = null;
        let openFiles = {}; // {path: {content, modified, mode}}
        let currentFile = null;
        let contextTarget = null;
        let newItemType = 'file';
        let newItemParent = '';

        // Initialize Ace Editor
        function initEditor() {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night");
            editor.setOptions({
                fontSize: "14px",
                showPrintMargin: false,
                enableBasicAutocompletion: true,
                tabSize: 4,
                useSoftTabs: true
            });

            editor.on('change', () => {
                if (currentFile && openFiles[currentFile]) {
                    // Compare with original content to determine if actually modified
                    const currentContent = editor.getValue();
                    const isModified = currentContent !== openFiles[currentFile].originalContent;
                    openFiles[currentFile].modified = isModified;
                    openFiles[currentFile].content = currentContent;
                    updateTabModified(currentFile);
                    updateToolbar();
                }
            });

            // Hide editor initially
            document.getElementById('editor').style.display = 'none';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveCurrentFile();
            }
        });

        // File tree
        async function loadTree() {
            const container = document.getElementById('fileTree');
            container.innerHTML = '<div style="padding:20px;color:#888;text-align:center">Loading...</div>';

            try {
                const resp = await fetch(`/api/project/${projectId}/editor/tree`);
                const result = await resp.json();

                if (!result.success) {
                    container.innerHTML = `<div style="padding:20px;color:#ff4444;text-align:center">${result.message}</div>`;
                    return;
                }

                container.innerHTML = renderTree(result.tree);
            } catch (err) {
                container.innerHTML = `<div style="padding:20px;color:#ff4444;text-align:center">Error loading files</div>`;
            }
        }

        function renderTree(items, level = 0) {
            if (!items || items.length === 0) return '';

            let html = '';
            for (const item of items) {
                if (item.type === 'dir') {
                    html += `
                        <div class="tree-item dir" onclick="toggleDir(this, event)" oncontextmenu="showContextMenu(event, '${item.path}', 'dir')">
                            <span class="icon">üìÅ</span>
                            <span class="name">${item.name}</span>
                        </div>
                        <div class="tree-children" data-path="${item.path}">
                            ${renderTree(item.children, level + 1)}
                        </div>
                    `;
                } else {
                    const icon = getFileIcon(item.name);
                    html += `
                        <div class="tree-item file" onclick="openFile('${item.path}')" oncontextmenu="showContextMenu(event, '${item.path}', 'file')">
                            <span class="icon">${icon}</span>
                            <span class="name">${item.name}</span>
                        </div>
                    `;
                }
            }
            return html;
        }

        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            const icons = {
                'php': 'üêò', 'js': 'üìú', 'ts': 'üìò', 'css': 'üé®', 'scss': 'üé®', 'less': 'üé®',
                'html': 'üåê', 'htm': 'üåê', 'vue': 'üíö', 'jsx': '‚öõÔ∏è', 'tsx': '‚öõÔ∏è',
                'json': 'üìã', 'xml': 'üìã', 'yaml': 'üìã', 'yml': 'üìã',
                'sql': 'üóÑÔ∏è', 'md': 'üìù', 'txt': 'üìÑ', 'log': 'üìÑ',
                'py': 'üêç', 'rb': 'üíé', 'java': '‚òï', 'go': 'üîµ', 'rs': 'ü¶Ä',
                'sh': '‚öôÔ∏è', 'bash': '‚öôÔ∏è', 'zsh': '‚öôÔ∏è',
                'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'svg': 'üñºÔ∏è',
                'pdf': 'üìï', 'zip': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶'
            };
            return icons[ext] || 'üìÑ';
        }

        function toggleDir(el, event) {
            event.stopPropagation();
            const children = el.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('open');
                const icon = el.querySelector('.icon');
                icon.textContent = children.classList.contains('open') ? 'üìÇ' : 'üìÅ';
            }
        }

        async function openFile(path) {
            // Check if already open
            if (openFiles[path]) {
                switchToFile(path);
                return;
            }

            try {
                const resp = await fetch(`/api/project/${projectId}/editor/file?path=${encodeURIComponent(path)}`);
                const result = await resp.json();

                if (!result.success) {
                    alert('Error: ' + result.message);
                    return;
                }

                // Determine mode from extension
                const mode = getModeForFile(path);

                openFiles[path] = {
                    content: result.content,
                    originalContent: result.content,
                    modified: false,
                    mode: mode
                };

                addTab(path);
                switchToFile(path);

            } catch (err) {
                alert('Error opening file: ' + err.message);
            }
        }

        function getModeForFile(path) {
            const ext = path.split('.').pop().toLowerCase();
            const modes = {
                'js': 'javascript', 'jsx': 'jsx', 'ts': 'typescript', 'tsx': 'tsx',
                'php': 'php', 'py': 'python', 'rb': 'ruby', 'java': 'java',
                'html': 'html', 'htm': 'html', 'vue': 'html',
                'css': 'css', 'scss': 'scss', 'less': 'less',
                'json': 'json', 'xml': 'xml', 'yaml': 'yaml', 'yml': 'yaml',
                'sql': 'sql', 'md': 'markdown', 'sh': 'sh', 'bash': 'sh',
                'go': 'golang', 'rs': 'rust', 'c': 'c_cpp', 'cpp': 'c_cpp', 'h': 'c_cpp'
            };
            return modes[ext] || 'text';
        }

        function addTab(path) {
            const tabs = document.getElementById('editorTabs');
            const fileName = path.split('/').pop();

            const tab = document.createElement('div');
            tab.className = 'editor-tab';
            tab.dataset.path = path;
            tab.innerHTML = `
                <span class="modified-dot" style="display:none"></span>
                <span class="name">${fileName}</span>
                <span class="close" onclick="closeTab(event, '${path}')">&times;</span>
            `;
            tab.onclick = (e) => {
                if (!e.target.classList.contains('close')) {
                    switchToFile(path);
                }
            };

            tabs.appendChild(tab);
        }

        function switchToFile(path) {
            currentFile = path;

            // Update tabs
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.path === path);
            });

            // Update tree
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show editor
            document.getElementById('editor').style.display = 'block';
            document.getElementById('noFile').style.display = 'none';

            // Set editor content and mode
            const file = openFiles[path];
            editor.setValue(file.content, -1);
            editor.session.setMode(`ace/mode/${file.mode}`);

            // Update toolbar
            updateToolbar();
        }

        function closeTab(event, path) {
            event.stopPropagation();

            const file = openFiles[path];
            if (file && file.modified) {
                if (!confirm('Discard unsaved changes?')) {
                    return;
                }
            }

            // Remove tab
            const tab = document.querySelector(`.editor-tab[data-path="${path}"]`);
            if (tab) tab.remove();

            // Remove from open files
            delete openFiles[path];

            // Switch to another file or show no-file
            const remainingPaths = Object.keys(openFiles);
            if (remainingPaths.length > 0) {
                switchToFile(remainingPaths[remainingPaths.length - 1]);
            } else {
                currentFile = null;
                document.getElementById('editor').style.display = 'none';
                document.getElementById('noFile').style.display = 'flex';
                updateToolbar();
            }
        }

        function updateTabModified(path) {
            const tab = document.querySelector(`.editor-tab[data-path="${path}"]`);
            if (tab) {
                const dot = tab.querySelector('.modified-dot');
                const file = openFiles[path];
                dot.style.display = file && file.modified ? 'block' : 'none';
            }
        }

        function updateToolbar() {
            const btnSave = document.getElementById('btnSave');
            const pathEl = document.getElementById('currentPath');
            const modifiedEl = document.getElementById('modifiedIndicator');

            if (currentFile) {
                pathEl.textContent = currentFile;
                const file = openFiles[currentFile];
                const isModified = file && file.modified;
                btnSave.disabled = !isModified;
                modifiedEl.style.display = isModified ? 'inline' : 'none';
            } else {
                pathEl.textContent = 'No file open';
                btnSave.disabled = true;
                modifiedEl.style.display = 'none';
            }
        }

        async function saveCurrentFile() {
            if (!currentFile || !openFiles[currentFile]) return;

            const file = openFiles[currentFile];
            const content = editor.getValue();

            try {
                const resp = await fetch(`/api/project/${projectId}/editor/file`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: currentFile, content: content})
                });
                const result = await resp.json();

                if (result.success) {
                    file.content = content;
                    file.originalContent = content;
                    file.modified = false;
                    updateTabModified(currentFile);
                    updateToolbar();
                } else {
                    alert('Error saving: ' + result.message);
                }
            } catch (err) {
                alert('Error saving: ' + err.message);
            }
        }

        function refreshTree() {
            loadTree();
        }

        // Context menu
        function showContextMenu(event, path, type) {
            event.preventDefault();
            event.stopPropagation();

            contextTarget = {path, type};

            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');
        }

        document.addEventListener('click', () => {
            document.getElementById('contextMenu').classList.remove('show');
        });

        function contextNewFile() {
            newItemType = 'file';
            newItemParent = contextTarget.type === 'dir' ? contextTarget.path : contextTarget.path.split('/').slice(0, -1).join('/');
            document.getElementById('modalTitle').textContent = 'New File';
            document.getElementById('newItemName').placeholder = 'filename.ext';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemModal').classList.add('show');
            document.getElementById('newItemName').focus();
        }

        function contextNewFolder() {
            newItemType = 'dir';
            newItemParent = contextTarget.type === 'dir' ? contextTarget.path : contextTarget.path.split('/').slice(0, -1).join('/');
            document.getElementById('modalTitle').textContent = 'New Folder';
            document.getElementById('newItemName').placeholder = 'folder-name';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemModal').classList.add('show');
            document.getElementById('newItemName').focus();
        }

        function showNewFileModal() {
            newItemType = 'file';
            newItemParent = '';
            document.getElementById('modalTitle').textContent = 'New File';
            document.getElementById('newItemName').placeholder = 'filename.ext';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemModal').classList.add('show');
            document.getElementById('newItemName').focus();
        }

        function showNewFolderModal() {
            newItemType = 'dir';
            newItemParent = '';
            document.getElementById('modalTitle').textContent = 'New Folder';
            document.getElementById('newItemName').placeholder = 'folder-name';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemModal').classList.add('show');
            document.getElementById('newItemName').focus();
        }

        function hideModal() {
            document.getElementById('newItemModal').classList.remove('show');
        }

        async function confirmNewItem() {
            const name = document.getElementById('newItemName').value.trim();
            if (!name) return;

            const path = newItemParent ? `${newItemParent}/${name}` : name;

            try {
                const resp = await fetch(`/api/project/${projectId}/editor/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: path, type: newItemType})
                });
                const result = await resp.json();

                if (result.success) {
                    hideModal();
                    refreshTree();
                    if (newItemType === 'file') {
                        setTimeout(() => openFile(path), 300);
                    }
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function contextRename() {
            document.getElementById('renameInput').value = contextTarget.path.split('/').pop();
            document.getElementById('renameModal').classList.add('show');
            document.getElementById('renameInput').focus();
            document.getElementById('renameInput').select();
        }

        function hideRenameModal() {
            document.getElementById('renameModal').classList.remove('show');
        }

        async function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (!newName) return;

            const oldPath = contextTarget.path;
            const parentPath = oldPath.split('/').slice(0, -1).join('/');
            const newPath = parentPath ? `${parentPath}/${newName}` : newName;

            try {
                const resp = await fetch(`/api/project/${projectId}/editor/rename`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({old_path: oldPath, new_path: newPath})
                });
                const result = await resp.json();

                if (result.success) {
                    hideRenameModal();

                    // Update open file if renamed
                    if (openFiles[oldPath]) {
                        openFiles[newPath] = openFiles[oldPath];
                        delete openFiles[oldPath];

                        const tab = document.querySelector(`.editor-tab[data-path="${oldPath}"]`);
                        if (tab) {
                            tab.dataset.path = newPath;
                            tab.querySelector('.name').textContent = newName;
                        }

                        if (currentFile === oldPath) {
                            currentFile = newPath;
                            updateToolbar();
                        }
                    }

                    refreshTree();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function contextDelete() {
            const path = contextTarget.path;
            const type = contextTarget.type;

            if (!confirm(`Delete ${type === 'dir' ? 'folder' : 'file'} "${path}"?`)) {
                return;
            }

            try {
                const resp = await fetch(`/api/project/${projectId}/files/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({path: path})
                });
                const result = await resp.json();

                if (result.success) {
                    // Close tab if file was open
                    if (openFiles[path]) {
                        closeTab({stopPropagation: () => {}}, path);
                    }
                    refreshTree();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Initialize
        initEditor();
        loadTree();
    </script>
</body>
</html>
