#cloud-config
# CodeHero - Automatic Installation
# This cloud-init script installs everything automatically

package_update: true
package_upgrade: true

packages:
  - unzip
  - wget
  - curl
  - net-tools

users:
  - name: claude
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: [sudo]

write_files:
  - path: /root/install-claude-system.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "=========================================="
      echo "  CodeHero - Auto Installer              "
      echo "=========================================="
      echo ""

      cd /root

      # Download latest release
      echo "[1/4] Downloading latest release..."
      LATEST_URL=$(curl -s https://api.github.com/repos/fotsakir/codehero/releases/latest | grep "browser_download_url.*zip" | cut -d '"' -f 4)
      wget -q --show-progress "$LATEST_URL" -O fotios-claude-system.zip

      # Extract
      echo "[2/4] Extracting..."
      unzip -q -o fotios-claude-system.zip
      cd fotios-claude-system

      # Run setup
      echo "[3/4] Running setup (this takes 10-15 minutes)..."
      chmod +x setup.sh
      ./setup.sh

      # Install Claude Code CLI (install only, don't run)
      echo "[4/4] Installing Claude Code CLI..."

      # Create claude user if not exists
      if ! id "claude" &>/dev/null; then
          useradd -m -s /bin/bash claude
          echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/claude
      fi

      # Install Node.js if needed
      if ! command -v node &>/dev/null; then
          curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
          apt-get install -y nodejs
      fi

      # Install Claude Code for claude user
      su - claude -c 'curl -fsSL https://claude.ai/install.sh | bash'
      su - claude -c 'echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> ~/.bashrc'

      echo "Claude Code installed. Run 'claude' as the claude user to activate."

      # Get IP address
      IP=$(hostname -I | awk '{print $1}')

      echo ""
      echo "=========================================="
      echo "  Installation Complete!"
      echo "=========================================="
      echo ""
      echo "  ACCESS POINTS:"
      echo "  Dashboard:    https://$IP:9453"
      echo "  Web Projects: https://$IP:9867"
      echo "  OLS Admin:    https://$IP:7080"
      echo ""
      echo "  LOGIN:"
      echo "  Username:  admin"
      echo "  Password:  admin123"
      echo ""
      echo "  IMPORTANT: Change passwords after first login:"
      echo "  sudo /opt/fotios-claude/scripts/change-passwords.sh"
      echo ""
      echo "  TO ACTIVATE CLAUDE CODE:"
      echo "  1. Open dashboard and click 'Activate Claude'"
      echo "  2. Or: su - claude && claude"
      echo ""
      echo "=========================================="

      # Mark installation as complete
      echo "done" > /root/install-complete

runcmd:
  - /root/install-claude-system.sh
